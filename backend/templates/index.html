{% extends "base.html" %}

{% block content %}
<div class="flex h-full w-full">
    <!-- Sidebar -->
    <div class="w-64 border-r border-zinc-800 bg-zinc-950 flex flex-col">
        <div class="p-4 border-b border-zinc-800 flex items-center justify-between">
            <h1 class="font-bold text-sm tracking-tight text-zinc-100">CodePilot v1.1</h1>
            <div class="flex items-center gap-1">
                <!-- Links instead of onclick -->
                <a href="#create-project-modal" class="p-1 hover:bg-zinc-800 rounded text-zinc-400 hover:text-blue-400"
                    title="Create Project">
                    <!-- <i data-lucide="plus-square" class="w-4 h-4"></i> No JS -> Text/Emoji or SVG -->
                    <span class="text-xs font-bold w-4 h-4 block text-center">+</span>
                </a>
                <a href="/picker?mode=open" class="p-1 hover:bg-zinc-800 rounded text-zinc-400 hover:text-green-400"
                    title="Open Project">
                    <!-- <i data-lucide="folder-search" class="w-4 h-4"></i> -->
                    <span class="text-xs font-bold w-4 h-4 block text-center">ðŸ“‚</span>
                </a>
                <div class="h-2 w-2 rounded-full bg-green-500 ml-2"></div>
            </div>
        </div>

        <!-- File Tree -->
        <div class="flex-1 overflow-y-auto p-2" id="file-tree-container">
            {% include "partials/file_tree.html" %}
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col min-w-0">
        <!-- Top Half: Editor & Chat -->
        <div class="flex-1 flex min-h-0">
            <!-- Editor -->
            <div class="flex-1 flex flex-col border-r border-zinc-800 min-w-0">
                <!-- Editor Area -->
                <div class="flex-1 flex flex-col bg-zinc-950 overflow-hidden relative">

                    <!-- Tab Bar -->
                    <div class="flex items-center bg-zinc-900 border-b border-zinc-800 overflow-x-auto">
                        {% for file_path in open_files %}
                        {% set fname = os.path.basename(file_path) %}
                        {% set is_active = (file_path == active_file_path) %}
                        <div
                            class="flex items-center px-3 py-2 border-r border-zinc-800 {{ 'bg-zinc-800 text-zinc-100' if is_active else 'text-zinc-500 hover:bg-zinc-800/50 hover:text-zinc-300' }}">
                            <a href="/?file={{ file_path }}" class="mr-2 text-sm">{{ fname }}</a>
                            <a href="/?close_file={{ file_path }}{{ '&file=' + active_file_path if active_file_path else '' }}"
                                class="text-xs hover:text-red-400">Ã—</a>
                        </div>
                        {% endfor %}

                        {% if not open_files %}
                        <div class="px-3 py-2 text-xs text-zinc-600 italic">No files open</div>
                        {% endif %}
                    </div>

                    <!-- Toolbar (Run / Stop / Save indication) -->
                    {% if active_file_path %}
                    <div class="h-10 border-b border-zinc-800 flex items-center px-4 justify-between bg-zinc-900/30">
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-zinc-400">{{ active_file_path }}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <!-- Run Button -->
                            <form action="/editor/run" method="POST" class="inline">
                                <input type="hidden" name="current_path" value="{{ active_file_path }}">
                                <button type="submit"
                                    class="p-1 hover:bg-zinc-800 rounded text-green-500 hover:text-green-400"
                                    title="Run Code">
                                    â–¶
                                </button>
                            </form>
                            <!-- Stop Button -->
                            <form action="/editor/stop" method="POST" class="inline">
                                <input type="hidden" name="current_path" value="{{ active_file_path }}">
                                <button type="submit"
                                    class="p-1 hover:bg-zinc-800 rounded text-red-500 hover:text-red-400"
                                    title="Stop Process">
                                    â– 
                                </button>
                            </form>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Editor (Textarea) -->
                    {% if active_file %}
                    <form action="/file/save" method="POST" class="flex-1 flex flex-col relative" id="editor-form">
                        <input type="hidden" name="path" value="{{ active_file_path }}">
                        <div class="flex-1 relative">
                            <textarea name="content" spellcheck="false"
                                class="w-full h-full bg-zinc-950 text-zinc-300 p-4 font-mono text-sm resize-none focus:outline-none"
                                onkeydown="if(event.ctrlKey && event.key === 's') { event.preventDefault(); this.form.submit(); }">{{ active_file_content }}</textarea>
                        </div>

                        <!-- Floating Save Button -->
                        <button type="submit"
                            class="absolute bottom-4 right-4 bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded shadow-lg text-sm font-medium z-10 opacity-50 hover:opacity-100 transition-opacity">
                            Save (âŒ˜S)
                        </button>
                    </form>
                    {% else %}
                    <div class="flex-1 flex items-center justify-center text-zinc-600">
                        <div class="text-center">
                            <p class="mb-2">Select a file to view</p>
                            <p class="text-xs">or create a new project</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Chat -->
            <div class="w-80 flex flex-col bg-zinc-950 min-w-0 border-l border-zinc-800">
                <div class="p-3 border-b border-zinc-800 flex justify-between items-center">
                    <span class="text-xs font-semibold text-zinc-300">AI Assistant</span>
                    <form action="/chat/clear" method="POST">
                        <input type="hidden" name="current_path" value="{{ active_file_path }}">
                        <button type="submit"
                            class="text-[10px] text-zinc-500 hover:text-red-400 uppercase tracking-wider">Clear</button>
                    </form>
                </div>
                <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
                    <!-- SSR Chat History -->
                    {% for msg in chat_history %}
                    <div class="flex flex-col space-y-1">
                        {% if msg.role == 'System' %}
                        <!-- Professional System Log -->
                        <div class="flex items-center gap-2 px-2 py-1">
                            <span class="text-zinc-500 text-xs">âš¡</span>
                            <span class="text-zinc-500 text-xs italic font-mono">{{ msg.content }}</span>
                        </div>
                        {% else %}
                        <!-- User / Agent -->
                        <div class="text-[10px] text-zinc-500 {{ 'text-right' if msg.role == 'User' else '' }}">{{
                            msg.role }}</div>
                        <div
                            class="text-xs p-3 rounded-lg border max-w-full break-words shadow-sm {{ 'bg-blue-600/10 border-blue-500/20 text-blue-100 self-end ml-4' if msg.role == 'User' else 'bg-zinc-900 border-zinc-800 text-zinc-300 mr-4 markdown-body' }}">
                            {{ msg.content | safe }}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}

                    {% if not chat_history %}
                    <div class="flex flex-col items-center justify-center h-full text-zinc-600 space-y-2">
                        <span class="text-2xl">ðŸ¤–</span>
                        <div class="text-xs text-center">How can I help you?</div>
                    </div>
                    {% endif %}
                </div>
                <!-- Chat Input Form -->
                <div class="p-3 border-t border-zinc-800">
                    <form action="/chat" method="POST" class="flex gap-2">
                        <input type="hidden" name="current_path" value="{{ active_file_path }}">
                        <input type="text" name="message" required
                            class="flex-1 bg-zinc-900 border border-zinc-800 rounded px-3 py-2 text-xs text-zinc-300 focus:outline-none focus:border-blue-500 placeholder-zinc-600"
                            placeholder="Ask CodePilot...">
                        <button type="submit"
                            class="px-3 py-2 bg-blue-600 hover:bg-blue-500 text-white text-xs rounded font-medium">Send</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Terminal (Bottom) -->
        <div class="h-64 border-t border-zinc-800 flex flex-col bg-zinc-950">
            <div class="h-8 border-b border-zinc-800 flex items-center px-4 justify-between bg-zinc-900/50">
                <div class="flex items-center space-x-2 text-xs text-zinc-400">
                    <span>_></span>
                    <span>Terminal</span>
                </div>
                <div class="text-xs text-zinc-500 font-mono">{{ cwd }}</div>
            </div>
            <!-- Terminal Output Log -->
            <div class="flex-1 overflow-y-auto p-2 font-mono text-xs text-zinc-400 whitespace-pre-wrap"
                id="terminal-log">{{ terminal_output }}</div>

            <!-- Terminal Input Form -->
            <form action="/terminal/exec" method="POST" class="border-t border-zinc-800 p-2 bg-zinc-900 flex gap-2">
                <span class="text-green-500 text-xs py-1 font-bold">âžœ</span>
                <input type="text" name="command" autocomplete="off" autofocus
                    class="flex-1 bg-transparent text-xs text-zinc-200 focus:outline-none placeholder-zinc-700 font-mono"
                    placeholder="ls, cd .., python3 script.py">
                <input type="hidden" name="current_path" value="{{ active_file_path }}">
            </form>

            <script>
                // Auto-scroll terminal to bottom
                const log = document.getElementById('terminal-log');
                if (log) log.scrollTop = log.scrollHeight;
            </script>
        </div>
    </div>
</div>

{% include "modals.html" %}
{% endblock %}